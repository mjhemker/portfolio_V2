<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vercel Deployment Diagnostic Tool</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .test-section {
            background: white;
            margin: 20px;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .status {
            padding: 12px 16px;
            margin: 12px 0;
            border-radius: 6px;
            font-weight: 500;
        }
        .status.success { background: #d4edda; border-left: 4px solid #28a745; color: #155724; }
        .status.error { background: #f8d7da; border-left: 4px solid #dc3545; color: #721c24; }
        .status.loading { background: #d1ecf1; border-left: 4px solid #17a2b8; color: #0c5460; }
        .status.warning { background: #fff3cd; border-left: 4px solid #ffc107; color: #856404; }
        .status.info { background: #e2e3e5; border-left: 4px solid #6c757d; color: #383d41; }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .file-info {
            background: #f8f9fa;
            padding: 15px;
            margin: 12px 0;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px 4px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        button.primary { 
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            padding: 12px 24px; 
            font-size: 14px; 
        }
        button.danger { 
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }
        video {
            max-width: 100%;
            height: 180px;
            margin: 12px 0;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            background: #f8f9fa;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }
        .summary-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .deployment-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .critical-finding {
            background: #ffebee;
            border: 2px solid #f44336;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Vercel Deployment Diagnostic Tool</h1>
            <p>Comprehensive analysis of video file accessibility on Vercel Pro deployment</p>
        </div>

        <div class="test-section">
            <h2>üìä Diagnostic Overview</h2>
            <div id="overview" class="status loading">Initializing comprehensive diagnostic...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <button class="primary" onclick="runFullDiagnostic()">üöÄ Run Complete Diagnostic</button>
            <button onclick="runQuickTest()">‚ö° Quick Test</button>
            <button onclick="exportResults()">üì• Export Results</button>
        </div>

        <div class="deployment-info">
            <h3>üåê Deployment Information</h3>
            <div id="deployment-info" class="file-info">
                <strong>Current URL:</strong> <span id="current-url"></span><br>
                <strong>Environment:</strong> <span id="environment"></span><br>
                <strong>User Agent:</strong> <span id="user-agent"></span><br>
                <strong>Connection:</strong> <span id="connection-info"></span>
            </div>
        </div>

        <div class="test-grid">
            <!-- Small File Test (Baseline) -->
            <div class="test-section">
                <h3>‚úÖ Baseline Test (12MB)</h3>
                <div class="file-info">
                    URL: /projects_assets/pantreat/demo_videos/input+filters.mp4<br>
                    Expected: Should work on all environments<br>
                    Purpose: Verify basic functionality
                </div>
                <div id="baseline-status" class="status info">Ready to test</div>
                <button onclick="testSpecificFile('baseline', '/projects_assets/pantreat/demo_videos/input+filters.mp4')">Test Baseline</button>
                <video id="baseline-video" controls preload="none" style="display: none;"></video>
            </div>

            <!-- Critical Threshold Test (64MB) -->
            <div class="test-section">
                <h3>üéØ Critical Threshold (64MB)</h3>
                <div class="file-info">
                    URL: /projects_assets/pantreat/demo_videos/feed.mp4<br>
                    Expected: May fail due to size limits<br>
                    Purpose: Identify size threshold
                </div>
                <div id="threshold-status" class="status info">Ready to test</div>
                <button onclick="testSpecificFile('threshold', '/projects_assets/pantreat/demo_videos/feed.mp4')">Test Threshold</button>
                <video id="threshold-video" controls preload="none" style="display: none;"></video>
            </div>

            <!-- Large File Test (79MB) -->
            <div class="test-section">
                <h3>‚ùå Large File Test (79MB)</h3>
                <div class="file-info">
                    URL: /projects_assets/pantreat/short_pantreat_interviews.mp4<br>
                    Expected: Known to fail with 'undefined' errors<br>
                    Purpose: Confirm the problem
                </div>
                <div id="large-status" class="status info">Ready to test</div>
                <button onclick="testSpecificFile('large', '/projects_assets/pantreat/short_pantreat_interviews.mp4')">Test Large File</button>
                <video id="large-video" controls preload="none" style="display: none;"></video>
            </div>

            <!-- Extra Large File Test (319MB) -->
            <div class="test-section">
                <h3>üö´ Extra Large Test (319MB)</h3>
                <div class="file-info">
                    URL: /projects_assets/video_essays/final_cut.mp4<br>
                    Expected: Definitely should fail<br>
                    Purpose: Confirm upper limit behavior
                </div>
                <div id="xl-status" class="status info">Ready to test</div>
                <button onclick="testSpecificFile('xl', '/projects_assets/video_essays/final_cut.mp4')">Test XL File</button>
                <video id="xl-video" controls preload="none" style="display: none;"></video>
            </div>
        </div>

        <div class="test-section">
            <h2>üîß Technical Analysis</h2>
            <div id="technical-analysis"></div>
            <button onclick="runTechnicalAnalysis()">Run Technical Analysis</button>
        </div>

        <div class="test-section">
            <h2>üìà Results Summary</h2>
            <div id="results-summary" class="summary-card" style="display: none;">
                <h3>üéØ Diagnostic Complete</h3>
                <div id="summary-content"></div>
            </div>
        </div>
    </div>

    <script>
        const diagnosticResults = {
            environment: {},
            tests: {},
            technicalInfo: {},
            startTime: Date.now()
        };

        let currentProgress = 0;
        const totalTests = 6; // 4 file tests + environment + technical

        function updateProgress(increment = 1) {
            currentProgress += increment;
            const percentage = (currentProgress / totalTests) * 100;
            document.getElementById('progress-fill').style.width = percentage + '%';
        }

        function updateOverview(message, type = 'loading') {
            const overview = document.getElementById('overview');
            overview.className = `status ${type}`;
            overview.textContent = message;
        }

        async function initializeEnvironment() {
            updateOverview('Gathering environment information...', 'loading');
            
            const currentUrl = window.location.href;
            const isVercel = currentUrl.includes('vercel.app') || currentUrl.includes('vercel.com');
            const isLocal = currentUrl.includes('localhost') || currentUrl.includes('127.0.0.1');
            
            diagnosticResults.environment = {
                url: currentUrl,
                isVercel,
                isLocal,
                userAgent: navigator.userAgent,
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink,
                    rtt: navigator.connection.rtt
                } : null,
                timestamp: new Date().toISOString()
            };

            // Update UI
            document.getElementById('current-url').textContent = currentUrl;
            document.getElementById('environment').textContent = isVercel ? 'Vercel Deployment' : isLocal ? 'Local Development' : 'Other';
            document.getElementById('user-agent').textContent = navigator.userAgent;
            document.getElementById('connection-info').textContent = navigator.connection ? 
                `${navigator.connection.effectiveType} (${navigator.connection.downlink}Mbps)` : 'Unknown';

            updateProgress();
        }

        async function testSpecificFile(testKey, url) {
            const statusEl = document.getElementById(`${testKey}-status`);
            const videoEl = document.getElementById(`${testKey}-video`);
            
            statusEl.className = 'status loading';
            statusEl.textContent = '‚è≥ Testing file accessibility...';
            
            const testResult = {
                url,
                startTime: Date.now(),
                accessible: false,
                loadable: false,
                httpStatus: null,
                error: null,
                fileSize: null,
                loadTime: 0,
                responseHeaders: {}
            };

            try {
                // Test URL accessibility
                const response = await fetch(url, { method: 'HEAD' });
                testResult.httpStatus = response.status;
                testResult.fileSize = response.headers.get('content-length');
                
                // Capture response headers
                for (const [key, value] of response.headers.entries()) {
                    testResult.responseHeaders[key] = value;
                }
                
                if (response.ok) {
                    testResult.accessible = true;
                    const sizeText = testResult.fileSize ? 
                        `${(parseInt(testResult.fileSize) / 1024 / 1024).toFixed(1)}MB` : 'Unknown';
                    
                    statusEl.textContent = `‚úÖ URL accessible (${sizeText}), testing video load...`;
                    
                    // Test video loading
                    videoEl.style.display = 'block';
                    videoEl.src = url;
                    
                    const loadPromise = new Promise((resolve) => {
                        const loadTimeout = setTimeout(() => {
                            testResult.error = 'Video load timeout (15 seconds)';
                            testResult.loadTime = Date.now() - testResult.startTime;
                            statusEl.className = 'status warning';
                            statusEl.textContent = `‚ö†Ô∏è URL works but video won't load (timeout)`;
                            resolve();
                        }, 15000);

                        videoEl.onloadedmetadata = () => {
                            clearTimeout(loadTimeout);
                            testResult.loadable = true;
                            testResult.loadTime = Date.now() - testResult.startTime;
                            testResult.duration = videoEl.duration;
                            statusEl.className = 'status success';
                            statusEl.textContent = `‚úÖ Perfect! ${sizeText}, ${videoEl.duration.toFixed(1)}s, loaded in ${testResult.loadTime}ms`;
                            resolve();
                        };

                        videoEl.onerror = () => {
                            clearTimeout(loadTimeout);
                            testResult.error = videoEl.error ? 
                                `Video Error ${videoEl.error.code}: ${getVideoErrorMessage(videoEl.error.code)}` : 
                                'Unknown video error';
                            testResult.loadTime = Date.now() - testResult.startTime;
                            statusEl.className = 'status error';
                            statusEl.textContent = `‚ùå URL accessible but video failed: ${testResult.error}`;
                            resolve();
                        };
                    });
                    
                    await loadPromise;
                } else {
                    testResult.error = `HTTP ${response.status} ${response.statusText}`;
                    statusEl.className = 'status error';
                    statusEl.textContent = `‚ùå URL not accessible: ${testResult.error}`;
                }
            } catch (error) {
                testResult.error = error.message;
                testResult.loadTime = Date.now() - testResult.startTime;
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå Network error: ${error.message}`;
            }
            
            diagnosticResults.tests[testKey] = testResult;
            updateProgress();
            analyzeResults();
        }

        function getVideoErrorMessage(errorCode) {
            const errors = {
                1: 'MEDIA_ERR_ABORTED - Video loading was aborted',
                2: 'MEDIA_ERR_NETWORK - Network error while loading video',
                3: 'MEDIA_ERR_DECODE - Video decode error',
                4: 'MEDIA_ERR_SRC_NOT_SUPPORTED - Video format not supported'
            };
            return errors[errorCode] || 'Unknown error';
        }

        async function runTechnicalAnalysis() {
            const analysisEl = document.getElementById('technical-analysis');
            analysisEl.innerHTML = '<h4>üîß Running technical analysis...</h4>';
            
            const analysis = {
                browser: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    cookieEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine
                },
                video: {
                    mp4Support: (() => {
                        const video = document.createElement('video');
                        return video.canPlayType('video/mp4');
                    })(),
                    webmSupport: (() => {
                        const video = document.createElement('video');
                        return video.canPlayType('video/webm');
                    })()
                },
                network: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink,
                    rtt: navigator.connection.rtt,
                    saveData: navigator.connection.saveData
                } : 'Connection API not supported'
            };

            // Test critical URLs
            const criticalUrls = [
                '/projects_assets/pantreat/demo_videos/MyPantry.mp4',
                '/projects_assets/pantreat/demo_videos/feed.mp4',
                '/projects_assets/pantreat/short_pantreat_interviews.mp4'
            ];

            analysis.urlTests = {};
            for (const url of criticalUrls) {
                try {
                    const response = await fetch(url, { method: 'HEAD' });
                    analysis.urlTests[url] = {
                        status: response.status,
                        size: response.headers.get('content-length'),
                        contentType: response.headers.get('content-type'),
                        cacheControl: response.headers.get('cache-control'),
                        etag: response.headers.get('etag')
                    };
                } catch (error) {
                    analysis.urlTests[url] = { error: error.message };
                }
            }

            diagnosticResults.technicalInfo = analysis;

            // Display results
            let html = '<div class="file-info">';
            html += `<strong>Browser Environment:</strong><br>`;
            html += `Platform: ${analysis.browser.platform}<br>`;
            html += `Online: ${analysis.browser.onLine}<br>`;
            html += `MP4 Support: ${analysis.video.mp4Support || 'Not supported'}<br><br>`;
            
            html += `<strong>Network Information:</strong><br>`;
            if (typeof analysis.network === 'object') {
                html += `Connection: ${analysis.network.effectiveType} (${analysis.network.downlink}Mbps)<br>`;
                html += `RTT: ${analysis.network.rtt}ms<br>`;
                html += `Data Saver: ${analysis.network.saveData}<br><br>`;
            } else {
                html += `${analysis.network}<br><br>`;
            }
            
            html += `<strong>URL Accessibility:</strong><br>`;
            for (const [url, result] of Object.entries(analysis.urlTests)) {
                const filename = url.split('/').pop();
                if (result.error) {
                    html += `‚ùå ${filename}: ${result.error}<br>`;
                } else {
                    const size = result.size ? `${(parseInt(result.size) / 1024 / 1024).toFixed(1)}MB` : 'Unknown';
                    html += `${result.status === 200 ? '‚úÖ' : '‚ùå'} ${filename}: HTTP ${result.status} (${size})<br>`;
                }
            }
            html += '</div>';
            
            analysisEl.innerHTML = html;
            updateProgress();
        }

        async function runFullDiagnostic() {
            currentProgress = 0;
            updateOverview('Running comprehensive diagnostic...', 'loading');
            
            await initializeEnvironment();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Test files in order of increasing size
            await testSpecificFile('baseline', '/projects_assets/pantreat/demo_videos/input+filters.mp4');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testSpecificFile('threshold', '/projects_assets/pantreat/demo_videos/feed.mp4');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testSpecificFile('large', '/projects_assets/pantreat/short_pantreat_interviews.mp4');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testSpecificFile('xl', '/projects_assets/video_essays/final_cut.mp4');
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await runTechnicalAnalysis();
            
            updateOverview('‚úÖ Comprehensive diagnostic completed!', 'success');
            showFinalSummary();
        }

        async function runQuickTest() {
            updateOverview('Running quick diagnostic...', 'loading');
            await initializeEnvironment();
            await testSpecificFile('threshold', '/projects_assets/pantreat/demo_videos/feed.mp4');
            await testSpecificFile('large', '/projects_assets/pantreat/short_pantreat_interviews.mp4');
            updateOverview('‚úÖ Quick test completed!', 'success');
            analyzeResults();
        }

        function analyzeResults() {
            const tests = diagnosticResults.tests;
            if (Object.keys(tests).length === 0) return;

            // Find the threshold
            const workingSizes = [];
            const failingSizes = [];
            
            for (const [key, result] of Object.entries(tests)) {
                if (result.fileSize) {
                    const sizeMB = parseInt(result.fileSize) / 1024 / 1024;
                    if (result.loadable) {
                        workingSizes.push(sizeMB);
                    } else {
                        failingSizes.push(sizeMB);
                    }
                }
            }

            if (workingSizes.length > 0 && failingSizes.length > 0) {
                const maxWorking = Math.max(...workingSizes);
                const minFailing = Math.min(...failingSizes);
                
                if (maxWorking < minFailing) {
                    const criticalFinding = document.createElement('div');
                    criticalFinding.className = 'critical-finding';
                    criticalFinding.innerHTML = `
                        <h3>üéØ Critical Finding: File Size Threshold Identified</h3>
                        <p><strong>Working up to:</strong> ${maxWorking.toFixed(1)}MB</p>
                        <p><strong>Failing from:</strong> ${minFailing.toFixed(1)}MB</p>
                        <p><strong>Recommendation:</strong> Files larger than ${maxWorking.toFixed(1)}MB should be hosted externally or compressed.</p>
                    `;
                    
                    // Insert after the technical analysis section
                    const technicalSection = document.getElementById('technical-analysis').parentElement;
                    technicalSection.insertAdjacentElement('afterend', criticalFinding);
                }
            }
        }

        function showFinalSummary() {
            const summaryCard = document.getElementById('results-summary');
            const summaryContent = document.getElementById('summary-content');
            
            const tests = diagnosticResults.tests;
            const totalTests = Object.keys(tests).length;
            const workingTests = Object.values(tests).filter(t => t.loadable).length;
            const accessibleTests = Object.values(tests).filter(t => t.accessible).length;
            
            let summaryHtml = `
                <div style="font-size: 18px; margin-bottom: 15px;">
                    üìä ${workingTests}/${totalTests} videos working perfectly<br>
                    üåê ${accessibleTests}/${totalTests} URLs accessible<br>
                    ‚è±Ô∏è Total diagnostic time: ${((Date.now() - diagnosticResults.startTime) / 1000).toFixed(1)}s
                </div>
            `;
            
            if (workingTests === totalTests) {
                summaryHtml += '<div style="color: #28a745;">‚úÖ All videos are working! No issues detected.</div>';
            } else if (accessibleTests > workingTests) {
                summaryHtml += '<div style="color: #ffc107;">‚ö†Ô∏è URLs accessible but videos won\'t load - likely a file size or format issue.</div>';
            } else {
                summaryHtml += '<div style="color: #dc3545;">‚ùå Videos not accessible - deployment or configuration issue.</div>';
            }
            
            summaryContent.innerHTML = summaryHtml;
            summaryCard.style.display = 'block';
        }

        function exportResults() {
            const report = {
                ...diagnosticResults,
                completedAt: new Date().toISOString(),
                totalDuration: Date.now() - diagnosticResults.startTime
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vercel-diagnostic-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            initializeEnvironment();
        });
    </script>
</body>
</html>